<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación de Competencias - CoRheSelect</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; text-align: center; }
        .logo { font-size: 48px; margin-bottom: 10px; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .header p { font-size: 16px; opacity: 0.9; }
        .hidden { display: none !important; }
        
        /* Welcome Screen */
        #welcomeScreen { padding: 40px; }
        .welcome-intro { background: #f7fafc; border-left: 4px solid #667eea; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .info-item { background: #f7fafc; padding: 16px; border-radius: 8px; }
        .info-icon { font-size: 24px; margin-bottom: 8px; }
        .info-label { font-size: 14px; color: #718096; margin-bottom: 4px; }
        .info-value { font-size: 16px; font-weight: 600; color: #2d3748; }
        
        .section-badge { background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; display: inline-block; font-size: 14px; font-weight: 600; margin: 10px 0; }
        
        .instructions { background: #fff; padding: 20px; margin: 20px 0; border-radius: 8px; border: 2px solid #e2e8f0; }
        .instructions h3 { color: #2d3748; margin-bottom: 15px; }
        .instructions ul { margin-left: 20px; }
        .instructions li { margin: 8px 0; color: #4a5568; }
        .instructions strong { color: #667eea; }
        
        .camera-check { background: #fff3cd; border: 2px solid #ffc107; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .camera-check h3 { color: #856404; margin-bottom: 10px; }
        
        .start-button { background: #667eea; color: white; border: none; padding: 16px 40px; font-size: 18px; border-radius: 10px; cursor: pointer; margin-top: 20px; width: 100%; transition: all 0.3s; }
        .start-button:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
        
        /* Section Transition */
        #sectionTransition { padding: 60px 40px; text-align: center; }
        .transition-icon { font-size: 80px; margin-bottom: 20px; animation: fadeInScale 0.6s ease-out; }
        .transition-title { font-size: 32px; color: #2d3748; margin-bottom: 15px; font-weight: 700; }
        .transition-message { font-size: 18px; color: #718096; margin-bottom: 30px; line-height: 1.6; }
        .transition-tips { background: #f7fafc; padding: 20px; border-radius: 10px; text-align: left; margin: 20px 0; }
        .transition-tips h4 { color: #667eea; margin-bottom: 10px; }
        .transition-tips ul { margin-left: 20px; }
        .transition-tips li { margin: 8px 0; color: #4a5568; }
        
        /* Question Screen */
        #questionContainer { padding: 40px; }
        .progress-container { background: #e2e8f0; height: 8px; border-radius: 10px; overflow: hidden; margin-bottom: 30px; }
        .progress-bar { background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; transition: width 0.3s; }
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .question-number { font-size: 18px; color: #4a5568; font-weight: 600; }
        .language-badge { background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .language-badge.english { background: #48bb78; }
        .question-text { font-size: 24px; color: #2d3748; margin-bottom: 20px; line-height: 1.5; background: #f7fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea; }
        
        /* Video Recording */
        .video-container { background: #000; border-radius: 10px; overflow: hidden; position: relative; margin: 20px 0; }
        #videoPreview { width: 100%; height: auto; display: block; }
        .video-placeholder { width: 100%; aspect-ratio: 16/9; background: #2d3748; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .video-placeholder .icon { font-size: 64px; margin-bottom: 10px; }
        
        .recording-status { position: absolute; top: 10px; left: 10px; background: rgba(220, 38, 38, 0.9); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; display: none; align-items: center; gap: 8px; z-index: 10; }
        .recording-status.active { display: flex; }
        .recording-dot { width: 12px; height: 12px; background: white; border-radius: 50%; animation: pulse 1s infinite; }
        
        .prep-phase { text-align: center; padding: 30px; background: #f7fafc; border-radius: 10px; margin: 20px 0; }
        .prep-phase h3 { color: #2d3748; margin-bottom: 15px; font-size: 22px; }
        .prep-phase p { color: #4a5568; font-size: 16px; line-height: 1.6; margin-bottom: 20px; }
        .prep-tips { background: white; border: 2px solid #e2e8f0; padding: 20px; border-radius: 8px; text-align: left; margin: 20px 0; }
        .prep-tips ul { margin-left: 20px; }
        .prep-tips li { margin: 8px 0; color: #4a5568; }
        
        .controls { display: flex; gap: 10px; margin-top: 20px; }
        .control-button { flex: 1; padding: 16px; font-size: 16px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-record { background: #dc2626; color: white; }
        .btn-record:hover { background: #b91c1c; }
        .btn-ready { background: #48bb78; color: white; }
        .btn-ready:hover { background: #38a169; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(72,187,120,0.4); }
        .btn-stop { background: #059669; color: white; }
        .btn-stop:hover { background: #047857; }
        .btn-review { background: #3b82f6; color: white; }
        .btn-review:hover { background: #2563eb; }
        .btn-retry { background: #f59e0b; color: white; }
        .btn-retry:hover { background: #d97706; }
        .btn-next { background: #10b981; color: white; }
        .btn-next:hover { background: #059669; }
        .btn-continue { background: #667eea; color: white; }
        .btn-continue:hover { background: #5568d3; }
        .btn-disabled { background: #cbd5e0; cursor: not-allowed; }
        
        .timer-display { text-align: center; font-size: 24px; font-weight: 600; color: #2d3748; margin: 15px 0; }
        
        /* Loading */
        #loadingScreen { padding: 60px 40px; text-align: center; }
        .spinner { border: 4px solid #e2e8f0; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; }
        
        /* Results */
        #resultsScreen { padding: 40px; text-align: center; }
        .success-icon { font-size: 64px; margin-bottom: 20px; }
        .results-title { font-size: 28px; color: #2d3748; margin-bottom: 10px; }
        .results-message { font-size: 18px; color: #718096; margin-bottom: 30px; line-height: 1.6; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes fadeInScale { 
            0% { opacity: 0; transform: scale(0.8); } 
            100% { opacity: 1; transform: scale(1); } 
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="logo">🎯</div>
            <h1>Evaluación de Competencias</h1>
            <p>CoRheSelect - Soft Skills & English Assessment</p>
        </div>

        <!-- LOADING SCREEN -->
        <div id="loadingScreen">
            <div class="spinner"></div>
            <p>Cargando evaluación...</p>
        </div>

        <!-- WELCOME SCREEN -->
        <div id="welcomeScreen" class="hidden">
            <h2>👋 Bienvenido/a a tu Evaluación de Competencias</h2>
            
            <div class="welcome-intro">
                <p>Esta evaluación consta de <strong>dos secciones</strong> que completarás grabándote en video. Tus respuestas serán evaluadas manualmente por nuestro equipo de selección.</p>
                <div style="margin-top: 15px;">
                    <span class="section-badge">📋 Parte 1: Soft Skills (Español)</span>
                    <span class="section-badge">🌍 Parte 2: English Assessment</span>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-icon">🎥</div>
                    <div class="info-label">Formato</div>
                    <div class="info-value">Respuestas en video</div>
                </div>
                <div class="info-item">
                    <div class="info-icon">⏱️</div>
                    <div class="info-label">Tiempo por respuesta</div>
                    <div class="info-value">2-3 minutos máximo</div>
                </div>
                <div class="info-item">
                    <div class="info-icon">📝</div>
                    <div class="info-label">Total de preguntas</div>
                    <div class="info-value" id="totalQuestions">-</div>
                </div>
                <div class="info-item">
                    <div class="info-icon">👤</div>
                    <div class="info-label">Evaluación</div>
                    <div class="info-value">Manual por headhunter</div>
                </div>
            </div>

            <div class="camera-check">
                <h3>⚠️ Requisitos técnicos:</h3>
                <ul style="margin-left: 25px; padding-left: 0;">
                    <li style="margin: 10px 0;">Debes permitir el acceso a tu cámara y micrófono</li>
                    <li style="margin: 10px 0;">Asegúrate de tener buena iluminación</li>
                    <li style="margin: 10px 0;">Busca un lugar tranquilo sin ruido de fondo</li>
                    <li style="margin: 10px 0;">Verifica que tu conexión a internet sea estable</li>
                </ul>
            </div>

            <div class="instructions">
                <h3>📋 Cómo funciona:</h3>
                <ul>
                    <li><strong>Lee la pregunta:</strong> Tómate el tiempo que necesites para leerla y preparar tu respuesta</li>
                    <li><strong>Cuando estés listo/a:</strong> Haz clic en "Estoy listo para grabar"</li>
                    <li><strong>Graba tu respuesta:</strong> Máximo 2-3 minutos por pregunta</li>
                    <li><strong>Revisa:</strong> Puedes ver tu video antes de continuar</li>
                    <li><strong>Re-grabar:</strong> Si no estás satisfecho/a, puedes grabar de nuevo</li>
                    <li><strong>Secciones:</strong> Primero preguntas en español, luego en inglés</li>
                </ul>
            </div>

            <div class="instructions" style="border-left: 4px solid #667eea;">
                <h3>🔒 Aviso de Privacidad y Consentimiento</h3>
                <p style="margin-bottom: 12px;">Al continuar con esta evaluación:</p>
                <ul style="font-size: 14px; line-height: 1.6;">
                    <li><strong>Recopilación de datos:</strong> Se grabarán videos de tus respuestas junto con tu información personal (nombre, email)</li>
                    <li><strong>Uso de datos:</strong> Los videos serán utilizados exclusivamente para evaluar tu candidatura en el proceso de selección</li>
                    <li><strong>Almacenamiento:</strong> Los videos se guardarán de forma segura en nuestros sistemas durante el proceso de selección</li>
                    <li><strong>Acceso:</strong> Solo el equipo de reclutamiento autorizado tendrá acceso a tus videos</li>
                    <li><strong>Retención:</strong> Los datos serán eliminados 90 días después de finalizado el proceso de selección o antes si lo solicitas</li>
                    <li><strong>Tus derechos:</strong> Puedes solicitar acceso, corrección o eliminación de tus datos en cualquier momento contactando a privacidad@corhreselect.com</li>
                </ul>
                
                <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin-top: 15px;">
                    <label style="display: flex; align-items: start; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="privacyConsent" style="margin-top: 4px; width: 18px; height: 18px; cursor: pointer;">
                        <span style="font-size: 14px; color: #2d3748;">
                            <strong>He leído y acepto el aviso de privacidad.</strong> Autorizo la grabación de videos y el tratamiento de mis datos personales para fines del proceso de selección.
                        </span>
                    </label>
                </div>
            </div>

            <button class="start-button" id="startButton" onclick="validateAndStart()" disabled style="opacity: 0.5; cursor: not-allowed;">
                Comenzar Evaluación
            </button>
        </div>

        <!-- SECTION TRANSITION -->
        <div id="sectionTransition" class="hidden">
            <div class="transition-icon">🌍</div>
            <h2 class="transition-title">English Assessment</h2>
            <p class="transition-message">
                Great job! You've completed the Soft Skills section.<br>
                Now we'll continue with the English assessment.
            </p>
            
            <div class="transition-tips">
                <h4>💡 Tips for the English section:</h4>
                <ul>
                    <li><strong>Speak naturally:</strong> Don't worry about being perfect</li>
                    <li><strong>Take your time:</strong> Read the question and prepare before recording</li>
                    <li><strong>Be yourself:</strong> We want to hear your authentic voice</li>
                    <li><strong>Relax:</strong> You're doing great!</li>
                </ul>
            </div>
            
            <button class="start-button btn-continue" onclick="continueToEnglishSection()">Continue to English Section →</button>
        </div>

        <!-- QUESTION SCREEN -->
        <div id="questionContainer" class="hidden">
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            
            <div class="question-header">
                <span class="question-number" id="questionNumber">Pregunta 1 de X</span>
                <span class="language-badge" id="languageBadge">🇪🇸 ESPAÑOL</span>
            </div>
            
            <div class="question-text" id="questionText"></div>
            
            <!-- Preparation Phase -->
            <div id="prepPhase" class="prep-phase">
                <h3>📖 <span id="prepTitle">Tómate tu tiempo para preparar</span></h3>
                <p id="prepMessage">Lee la pregunta con atención y prepara mentalmente tu respuesta. Cuando estés listo/a para grabar, haz clic en el botón de abajo.</p>
                
                <div class="prep-tips">
                    <strong>💡 Consejos:</strong>
                    <ul>
                        <li>Piensa en ejemplos concretos de tu experiencia</li>
                        <li>Estructura tu respuesta: contexto → acción → resultado</li>
                        <li>Habla con naturalidad, como en una conversación</li>
                        <li>No hay prisa, tómate el tiempo que necesites</li>
                    </ul>
                </div>
                
                <button class="start-button btn-ready" onclick="showRecordingPhase()">
                    ✅ <span id="btnReadyText">Estoy listo/a para grabar</span>
                </button>
            </div>
            
            <!-- Recording Phase -->
            <div id="recordingPhase" class="hidden">
                <div class="video-container">
                    <video id="videoPreview" autoplay muted playsinline></video>
                    <div class="recording-status" id="recordingStatus">
                        <div class="recording-dot"></div>
                        <span id="recordingText">GRABANDO</span>
                    </div>
                </div>
                
                <div class="timer-display" id="recordingTimer">00:00</div>
                
                <div class="controls" id="recordingControls">
                    <button class="control-button btn-record" id="btnStartRecord" onclick="startRecording()">
                        🎥 <span id="btnRecordText">Comenzar Grabación</span>
                    </button>
                    <button class="control-button btn-stop hidden" id="btnStopRecord" onclick="stopRecording()">
                        ⏹️ <span id="btnStopText">Detener Grabación</span>
                    </button>
                </div>
            </div>
            
            <!-- Review Phase -->
            <div id="reviewPhase" class="hidden">
                <div class="video-container">
                    <video id="videoPlayback" controls playsinline></video>
                </div>
                
                <div class="controls">
                    <button class="control-button btn-retry" onclick="retryRecording()">
                        🔄 <span id="btnRetryText">Grabar de nuevo</span>
                    </button>
                    <button class="control-button btn-next" onclick="confirmAndNext()">
                        ✓ <span id="btnNextText">Confirmar y Continuar</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- RESULTS SCREEN -->
        <div id="resultsScreen" class="hidden">
            <div class="success-icon">✅</div>
            <h2 class="results-title">¡Evaluación Completada!</h2>
            <p class="results-message">
                Gracias por completar la evaluación de competencias. Hemos recibido todas tus respuestas en video exitosamente.
                <br><br>
                <strong>Thank you for completing the assessment!</strong> We have received all your video responses.
                <br><br>
                Nuestro equipo de selección revisará tus respuestas y nos pondremos en contacto contigo pronto con los resultados del proceso.
            </p>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURACIÓN
        // ============================================
        
        const CONFIG = {
            AIRTABLE_API_KEY: 'pat8oZQ31bhFCgtiu.1b614abc17a743d1438108fab30e7d7affc095b7d0f7269d0b03dfa77b502ac6',
            GOOGLE_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyI5ZK17xa-YHJzPJ9mC0EGnIXLSlAgzqtXEml_MTP-8JxfG0Iw7d1cJE0TtsyDSb9k2Q/exec',
            AIRTABLE_BASE_ID: 'appvaNZdmHt24cHJV',
            MAX_RECORDING_SECONDS: 180
        };

        const TABLES = {
            EVALUATIONS: 'tblaMFH86OlzCp9dj',
            RESULTS: 'tbl3LOdaZaMfAGBxP',
            QUESTIONS: 'tbl8wHh68rNh4h1Zp'
        };

        let state = {
            evaluationId: null,
            candidateEmail: null,
            currentQuestionIndex: 0,
            questions: [],
            softSkillsCount: 0,
            mediaRecorder: null,
            recordedChunks: [],
            stream: null,
            currentBlob: null,
            currentSection: 'softskills'
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        async function airtableRequest(tableId, recordId = '', method = 'GET', data = null) {
            const url = `https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${tableId}${recordId ? '/' + recordId : ''}`;
            
            const options = {
                method: method,
                headers: {
                    'Authorization': `Bearer ${CONFIG.AIRTABLE_API_KEY}`,
                    'Content-Type': 'application/json'
                }
            };
            
            if (data && (method === 'POST' || method === 'PATCH')) {
                options.body = JSON.stringify(data);
            }
            
            const response = await fetch(url, options);
            if (!response.ok) {
                throw new Error(`Airtable error: ${response.status}`);
            }
            
            return await response.json();
        }

        // ============================================
        // CAMERA FUNCTIONS
        // ============================================
        
        function validateAndStart() {
            const consent = document.getElementById('privacyConsent');
            if (!consent.checked) {
                alert('Por favor, lee y acepta el aviso de privacidad para continuar.');
                return;
            }
            requestCameraAccess();
        }
        
        async function requestCameraAccess() {
            try {
                state.stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }, 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                document.getElementById('videoPreview').srcObject = state.stream;
                startEvaluation();
                
            } catch (error) {
                alert('No se pudo acceder a la cámara. Por favor, verifica los permisos y vuelve a intentar.');
                console.error('Error accediendo a cámara:', error);
            }
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        async function init() {
            try {
                state.evaluationId = getUrlParameter('id');
                
                if (!state.evaluationId) {
                    throw new Error('ID de evaluación no proporcionado');
                }
                
                await loadEvaluationData();
                
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('welcomeScreen').classList.remove('hidden');
                
            } catch (error) {
                alert('Error cargando la evaluación. Verifica el enlace e intenta de nuevo.');
                console.error('Error en init:', error);
            }
        }

        async function loadEvaluationData() {
            try {
                const resultData = await airtableRequest(TABLES.RESULTS, state.evaluationId);
                
                if (!resultData.fields['Activo']) {
                    throw new Error('Esta evaluación ya no está activa');
                }
                
                const evaluationId = resultData.fields['Evaluación asignada']?.[0];
                if (!evaluationId) {
                    throw new Error('No se encontró la evaluación asociada');
                }
                
                const evaluationData = await airtableRequest(TABLES.EVALUATIONS, evaluationId);
                
                const softSkillsIds = evaluationData.fields['Preguntas soft skills'] || [];
                const englishIds = evaluationData.fields['Preguntas inglés'] || [];
                
                if (softSkillsIds.length === 0 && englishIds.length === 0) {
                    throw new Error('No hay preguntas configuradas para esta evaluación');
                }
                
                const allQuestionIds = [...softSkillsIds, ...englishIds];
                const questionsData = await Promise.all(
                    allQuestionIds.map(id => airtableRequest(TABLES.QUESTIONS, id))
                );
                
                state.questions = [];
                
                // Función para limpiar el texto de la pregunta
                function cleanQuestionText(text) {
                    if (!text) return '';
                    
                    // Si tiene " – " (guion largo), toma solo la parte ANTES del primer " – "
                    if (text.includes(' – ')) {
                        return text.split(' – ')[0].trim();
                    }
                    
                    // Si tiene " - " (guion corto con espacios), igual
                    if (text.includes(' - ')) {
                        return text.split(' - ')[0].trim();
                    }
                    
                    // Si no tiene guiones, devuelve el texto original
                    return text.trim();
                }
                
                // Agregar preguntas de Soft Skills
                softSkillsIds.forEach((id) => {
                    const questionData = questionsData.find(q => q.id === id);
                    if (questionData && questionData.fields && questionData.fields['Pregunta']) {
                        state.questions.push({
                            id: questionData.id,
                            text: cleanQuestionText(questionData.fields['Pregunta']),
                            type: 'softskills',
                            language: 'es'
                        });
                    }
                });
                
                state.softSkillsCount = state.questions.length;
                
                // Agregar preguntas de Inglés
                englishIds.forEach((id) => {
                    const questionData = questionsData.find(q => q.id === id);
                    if (questionData && questionData.fields && questionData.fields['Pregunta']) {
                        state.questions.push({
                            id: questionData.id,
                            text: cleanQuestionText(questionData.fields['Pregunta']),
                            type: 'english',
                            language: 'en'
                        });
                    }
                });
                
                const englishCount = state.questions.length - state.softSkillsCount;
                
                document.getElementById('totalQuestions').textContent = 
                    `${state.questions.length} preguntas (${state.softSkillsCount} Soft Skills + ${englishCount} English)`;
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                throw error;
            }
        }

        // ============================================
        // EVALUATION FLOW
        // ============================================
        
        function startEvaluation() {
            state.currentQuestionIndex = 0;
            state.currentSection = 'softskills';
            
            document.getElementById('welcomeScreen').classList.add('hidden');
            document.getElementById('questionContainer').classList.remove('hidden');
            
            showQuestion();
        }

        function showQuestion() {
            const question = state.questions[state.currentQuestionIndex];
            
            if (state.currentQuestionIndex === state.softSkillsCount && state.currentSection === 'softskills') {
                showSectionTransition();
                return;
            }
            
            const progress = ((state.currentQuestionIndex + 1) / state.questions.length) * 100;
            document.getElementById('progressBar').style.width = progress + '%';
            
            let questionNumberText = '';
            let languageBadgeHTML = '';
            
            if (question.type === 'softskills') {
                const softSkillsNum = state.currentQuestionIndex + 1;
                questionNumberText = `Pregunta ${softSkillsNum} de ${state.softSkillsCount}`;
                languageBadgeHTML = '<span class="language-badge">🇪🇸 ESPAÑOL</span>';
                
                document.getElementById('prepTitle').textContent = 'Tómate tu tiempo para preparar';
                document.getElementById('prepMessage').textContent = 'Lee la pregunta con atención y prepara mentalmente tu respuesta. Cuando estés listo/a para grabar, haz clic en el botón de abajo.';
                document.getElementById('btnReadyText').textContent = 'Estoy listo/a para grabar';
                document.getElementById('btnRecordText').textContent = 'Comenzar Grabación';
                document.getElementById('btnStopText').textContent = 'Detener Grabación';
                document.getElementById('btnRetryText').textContent = 'Grabar de nuevo';
                document.getElementById('btnNextText').textContent = 'Confirmar y Continuar';
                document.getElementById('recordingText').textContent = 'GRABANDO';
            } else {
                const englishNum = state.currentQuestionIndex - state.softSkillsCount + 1;
                const englishTotal = state.questions.length - state.softSkillsCount;
                questionNumberText = `Question ${englishNum} of ${englishTotal}`;
                languageBadgeHTML = '<span class="language-badge english">🇬🇧 ENGLISH</span>';
                
                document.getElementById('prepTitle').textContent = 'Take your time to prepare';
                document.getElementById('prepMessage').textContent = 'Read the question carefully and prepare your answer mentally. When you\'re ready to record, click the button below.';
                document.getElementById('btnReadyText').textContent = 'I\'m ready to record';
                document.getElementById('btnRecordText').textContent = 'Start Recording';
                document.getElementById('btnStopText').textContent = 'Stop Recording';
                document.getElementById('btnRetryText').textContent = 'Record again';
                document.getElementById('btnNextText').textContent = 'Confirm and Continue';
                document.getElementById('recordingText').textContent = 'RECORDING';
            }
            
            document.getElementById('questionNumber').textContent = questionNumberText;
            document.getElementById('languageBadge').outerHTML = languageBadgeHTML;
            
            document.getElementById('questionText').textContent = question.text;
            
            document.getElementById('prepPhase').classList.remove('hidden');
            document.getElementById('recordingPhase').classList.add('hidden');
            document.getElementById('reviewPhase').classList.add('hidden');
        }

        function showSectionTransition() {
            document.getElementById('questionContainer').classList.add('hidden');
            document.getElementById('sectionTransition').classList.remove('hidden');
        }

        function continueToEnglishSection() {
            state.currentSection = 'english';
            document.getElementById('sectionTransition').classList.add('hidden');
            document.getElementById('questionContainer').classList.remove('hidden');
            showQuestion();
        }

        function showRecordingPhase() {
            document.getElementById('prepPhase').classList.add('hidden');
            document.getElementById('recordingPhase').classList.remove('hidden');
            
            document.getElementById('videoPreview').srcObject = state.stream;
            document.getElementById('btnStartRecord').classList.remove('hidden');
            document.getElementById('btnStopRecord').classList.add('hidden');
            document.getElementById('recordingStatus').classList.remove('active');
        }

        // ============================================
        // VIDEO RECORDING
        // ============================================
        
        function startRecording() {
            state.recordedChunks = [];
            
            const options = { mimeType: 'video/webm;codecs=vp9,opus' };
            
            try {
                state.mediaRecorder = new MediaRecorder(state.stream, options);
            } catch (e) {
                state.mediaRecorder = new MediaRecorder(state.stream);
            }
            
            state.mediaRecorder.ondataavailable = (event) => {
                if (event.data && event.data.size > 0) {
                    state.recordedChunks.push(event.data);
                }
            };
            
            state.mediaRecorder.onstop = () => {
                state.currentBlob = new Blob(state.recordedChunks, { type: 'video/webm' });
                showReviewPhase();
            };
            
            state.mediaRecorder.start();
            
            document.getElementById('btnStartRecord').classList.add('hidden');
            document.getElementById('btnStopRecord').classList.remove('hidden');
            document.getElementById('recordingStatus').classList.add('active');
            
            startRecordingTimer();
        }

        function stopRecording() {
            if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                state.mediaRecorder.stop();
                
                if (state.recordingInterval) {
                    clearInterval(state.recordingInterval);
                }
                
                document.getElementById('recordingStatus').classList.remove('active');
            }
        }

        function startRecordingTimer() {
            let elapsed = 0;
            document.getElementById('recordingTimer').textContent = formatTime(elapsed);
            
            state.recordingInterval = setInterval(() => {
                elapsed++;
                document.getElementById('recordingTimer').textContent = formatTime(elapsed);
                
                if (elapsed >= CONFIG.MAX_RECORDING_SECONDS) {
                    stopRecording();
                }
            }, 1000);
        }

        function showReviewPhase() {
            document.getElementById('recordingPhase').classList.add('hidden');
            document.getElementById('reviewPhase').classList.remove('hidden');
            
            const videoPlayback = document.getElementById('videoPlayback');
            videoPlayback.src = URL.createObjectURL(state.currentBlob);
        }

        function retryRecording() {
            showRecordingPhase();
        }

        async function confirmAndNext() {
            try {
                const loadingText = state.currentSection === 'english' ? 'Saving video...' : 'Guardando video...';
                document.getElementById('questionContainer').innerHTML = `<div style="text-align: center; padding: 40px;"><div class="spinner"></div><p>${loadingText}</p></div>`;
                
                await saveVideoResponse();
                
                state.currentQuestionIndex++;
                
                if (state.currentQuestionIndex < state.questions.length) {
                    location.reload();
                } else {
                    finishEvaluation();
                }
                
            } catch (error) {
                const errorText = state.currentSection === 'english' ? 
                    'Error saving video. Please try again.' : 
                    'Error al guardar el video. Por favor, intenta de nuevo.';
                alert(errorText);
                console.error('Error:', error);
            }
        }

        async function saveVideoResponse() {
            try {
                const question = state.questions[state.currentQuestionIndex];
                
                const reader = new FileReader();
                const base64Promise = new Promise((resolve) => {
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(state.currentBlob);
                });
                
                const base64Data = await base64Promise;
                
                // Enviar a Google Sheets via Apps Script
                const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Google Apps Script requiere no-cors
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        evaluationId: state.evaluationId,
                        questionId: question.id,
                        videoData: base64Data,
                        videoType: question.type
                    })
                });
                
                // Con mode: no-cors, no podemos leer la respuesta, pero si llega aquí, se envió
                console.log('Video enviado a Google Sheets exitosamente');
                
            } catch (error) {
                console.error('Error guardando video:', error);
                throw error;
            }
        }
                
            } catch (error) {
                console.error('Error guardando video:', error);
                throw error;
            }
        }

        async function finishEvaluation() {
            try {
                if (state.stream) {
                    state.stream.getTracks().forEach(track => track.stop());
                }
                
                // Ya no necesitamos desactivar via API
                // La automatización puede hacerlo si es necesario
                
                document.getElementById('questionContainer').classList.add('hidden');
                document.getElementById('resultsScreen').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error al finalizar evaluación:', error);
                // Mostrar resultados de todos modos
                document.getElementById('questionContainer').classList.add('hidden');
                document.getElementById('resultsScreen').classList.remove('hidden');
            }
        }

        // ============================================
        // INITIALIZATION ON PAGE LOAD
        // ============================================
        
        window.addEventListener('DOMContentLoaded', init);
        
        document.addEventListener('DOMContentLoaded', function() {
            const checkbox = document.getElementById('privacyConsent');
            const button = document.getElementById('startButton');
            
            if (checkbox && button) {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        button.disabled = false;
                        button.style.opacity = '1';
                        button.style.cursor = 'pointer';
                    } else {
                        button.disabled = true;
                        button.style.opacity = '0.5';
                        button.style.cursor = 'not-allowed';
                    }
                });
            }
        });
        
        window.addEventListener('beforeunload', (e) => {
            if (state.currentQuestionIndex > 0 && state.currentQuestionIndex < state.questions.length) {
                e.preventDefault();
                e.returnValue = '¿Estás seguro de que quieres salir? Tu progreso se perderá.';
            }
        });
    </script>
</body>
</html>
