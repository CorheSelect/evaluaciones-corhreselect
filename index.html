<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación de Competencias - CoRheSelect</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; text-align: center; }
        .logo { font-size: 48px; margin-bottom: 10px; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .header p { font-size: 16px; opacity: 0.9; }
        .hidden { display: none !important; }
        
        /* Welcome Screen */
        #welcomeScreen { padding: 40px; }
        .welcome-intro { background: #f7fafc; border-left: 4px solid #667eea; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; }
        .info-item { background: #f7fafc; padding: 16px; border-radius: 8px; }
        .info-icon { font-size: 24px; margin-bottom: 8px; }
        .info-label { font-size: 14px; color: #718096; margin-bottom: 4px; }
        .info-value { font-size: 16px; font-weight: 600; color: #2d3748; }
        
        .section-badge { background: #667eea; color: white; padding: 8px 16px; border-radius: 20px; display: inline-block; font-size: 14px; font-weight: 600; margin: 10px 0; }
        
        .instructions { background: #fff; padding: 20px; margin: 20px 0; border-radius: 8px; border: 2px solid #e2e8f0; }
        .instructions h3 { color: #2d3748; margin-bottom: 15px; }
        .instructions ul { margin-left: 20px; }
        .instructions li { margin: 8px 0; color: #4a5568; }
        .instructions strong { color: #667eea; }
        
        .camera-check { background: #fff3cd; border: 2px solid #ffc107; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .camera-check h3 { color: #856404; margin-bottom: 10px; }
        
        .start-button { background: #667eea; color: white; border: none; padding: 16px 40px; font-size: 18px; border-radius: 10px; cursor: pointer; margin-top: 20px; width: 100%; transition: all 0.3s; }
        .start-button:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102,126,234,0.4); }
        
        /* Section Transition */
        #sectionTransition { padding: 60px 40px; text-align: center; }
        .transition-icon { font-size: 80px; margin-bottom: 20px; animation: fadeInScale 0.6s ease-out; }
        .transition-title { font-size: 32px; color: #2d3748; margin-bottom: 15px; font-weight: 700; }
        .transition-message { font-size: 18px; color: #718096; margin-bottom: 30px; line-height: 1.6; }
        .transition-tips { background: #f7fafc; padding: 20px; border-radius: 10px; text-align: left; margin: 20px 0; }
        .transition-tips h4 { color: #667eea; margin-bottom: 10px; }
        .transition-tips ul { margin-left: 20px; }
        .transition-tips li { margin: 8px 0; color: #4a5568; }
        
        /* Question Screen */
        #questionContainer { padding: 40px; position: relative; }
        .progress-container { background: #e2e8f0; height: 8px; border-radius: 10px; overflow: hidden; margin-bottom: 30px; }
        .progress-bar { background: linear-gradient(90deg, #667eea, #764ba2); height: 100%; transition: width 0.3s; }
        .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .question-number { font-size: 18px; color: #4a5568; font-weight: 600; }
        .language-badge { background: #667eea; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .language-badge.english { background: #48bb78; }
        .question-text { font-size: 24px; color: #2d3748; margin-bottom: 20px; line-height: 1.5; background: #f7fafc; padding: 20px; border-radius: 10px; border-left: 4px solid #667eea; }
        
        /* Video Recording */
        .video-container { background: #000; border-radius: 10px; overflow: hidden; position: relative; margin: 20px 0; }
        #videoPreview { width: 100%; height: auto; display: block; }
        .video-placeholder { width: 100%; aspect-ratio: 16/9; background: #2d3748; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .video-placeholder .icon { font-size: 64px; margin-bottom: 10px; }
        
        .recording-status { position: absolute; top: 10px; left: 10px; background: rgba(220, 38, 38, 0.9); color: white; padding: 8px 16px; border-radius: 20px; font-weight: 600; display: none; align-items: center; gap: 8px; z-index: 10; }
        .recording-status.active { display: flex; }
        .recording-dot { width: 12px; height: 12px; background: white; border-radius: 50%; animation: pulse 1s infinite; }
        
        .prep-phase { text-align: center; padding: 30px; background: #f7fafc; border-radius: 10px; margin: 20px 0; }
        .prep-phase h3 { color: #2d3748; margin-bottom: 15px; font-size: 22px; }
        .prep-phase p { color: #4a5568; font-size: 16px; line-height: 1.6; margin-bottom: 20px; }
        .prep-tips { background: white; border: 2px solid #e2e8f0; padding: 20px; border-radius: 8px; text-align: left; margin: 20px 0; }
        .prep-tips ul { margin-left: 20px; }
        .prep-tips li { margin: 8px 0; color: #4a5568; }
        
        .controls { display: flex; gap: 10px; margin-top: 20px; }
        .control-button { flex: 1; padding: 16px; font-size: 16px; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; }
        .btn-record { background: #dc2626; color: white; }
        .btn-record:hover { background: #b91c1c; }
        .btn-ready { background: #48bb78; color: white; }
        .btn-ready:hover { background: #38a169; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(72,187,120,0.4); }
        .btn-stop { background: #059669; color: white; }
        .btn-stop:hover { background: #047857; }
        .btn-review { background: #3b82f6; color: white; }
        .btn-review:hover { background: #2563eb; }
        .btn-retry { background: #f59e0b; color: white; }
        .btn-retry:hover { background: #d97706; }
        .btn-next { background: #10b981; color: white; }
        .btn-next:hover { background: #059669; }
        .btn-continue { background: #667eea; color: white; }
        .btn-continue:hover { background: #5568d3; }
        .btn-disabled { background: #cbd5e0; cursor: not-allowed; }
        
        .timer-display { text-align: center; font-size: 24px; font-weight: 600; color: #2d3748; margin: 15px 0; }
        
        /* Loading Overlay - NUEVO */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            border-radius: 10px;
        }
        .loading-overlay.active {
            display: flex;
        }
        .loading-content {
            text-align: center;
        }
        
        /* Loading */
        #loadingScreen { padding: 60px 40px; text-align: center; }
        .spinner { border: 4px solid #e2e8f0; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 20px auto; }
        
        /* Results */
        #resultsScreen { padding: 40px; text-align: center; }
        .success-icon { font-size: 64px; margin-bottom: 20px; }
        .results-title { font-size: 28px; color: #2d3748; margin-bottom: 10px; }
        .results-message { font-size: 18px; color: #718096; margin-bottom: 30px; line-height: 1.6; }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @keyframes fadeInScale { 
            0% { opacity: 0; transform: scale(0.8); } 
            100% { opacity: 1; transform: scale(1); } 
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- HEADER -->
        <div class="header">
            <div class="logo">🎯</div>
            <h1>Evaluación de Competencias</h1>
            <p>CoRheSelect - Soft Skills & English Assessment</p>
        </div>

        <!-- LOADING SCREEN -->
        <div id="loadingScreen">
            <div class="spinner"></div>
            <p>Cargando evaluación...</p>
        </div>

        <!-- WELCOME SCREEN -->
        <div id="welcomeScreen" class="hidden">
            <h2>👋 Bienvenido/a a tu Evaluación de Competencias</h2>
            
            <div class="welcome-intro">
                <p>Esta evaluación consta de <strong>dos secciones</strong> que completarás grabándote en video. Tus respuestas serán evaluadas manualmente por nuestro equipo de selección.</p>
                <div style="margin-top: 15px;">
                    <span class="section-badge">📋 Parte 1: Soft Skills (Español)</span>
                    <span class="section-badge">🌍 Parte 2: English Assessment</span>
                </div>
            </div>

            <div class="info-grid">
                <div class="info-item">
                    <div class="info-icon">🎥</div>
                    <div class="info-label">Formato</div>
                    <div class="info-value">Respuestas en video</div>
                </div>
                <div class="info-item">
                    <div class="info-icon">⏱️</div>
                    <div class="info-label">Tiempo por respuesta</div>
                    <div class="info-value">2-3 minutos máximo</div>
                </div>
                <div class="info-item">
                    <div class="info-icon">📝</div>
                    <div class="info-label">Preguntas totales</div>
                    <div class="info-value" id="totalQuestions">-</div>
                </div>
                <div class="info-item">
                    <div class="info-icon">🕐</div>
                    <div class="info-label">Duración estimada</div>
                    <div class="info-value" id="estimatedTime">-</div>
                </div>
            </div>

            <div class="instructions">
                <h3>📋 Instrucciones Importantes</h3>
                <ul>
                    <li><strong>Tiempo de preparación:</strong> Tendrás 60 segundos para leer y preparar tu respuesta antes de grabar</li>
                    <li><strong>Tiempo de grabación:</strong> Máximo 3 minutos por pregunta</li>
                    <li><strong>Revisión:</strong> Podrás revisar y regrabar cada respuesta antes de continuar</li>
                    <li><strong>Ambiente:</strong> Busca un lugar tranquilo con buena iluminación</li>
                    <li><strong>Dispositivo:</strong> Asegúrate de tener cámara y micrófono funcionando</li>
                </ul>
            </div>

            <div class="camera-check">
                <h3>⚠️ Verificación Técnica</h3>
                <p>Antes de comenzar, esta aplicación solicitará acceso a tu cámara y micrófono. Por favor, <strong>acepta los permisos</strong> cuando se soliciten.</p>
            </div>

            <div style="background: #e6f4ff; padding: 20px; border-radius: 8px; border-left: 4px solid #1890ff; margin: 20px 0;">
                <h3 style="color: #0050b3; margin-bottom: 10px;">🔒 Privacidad y Uso de Datos</h3>
                <p style="color: #003a8c; line-height: 1.6; margin-bottom: 15px;">
                    Tus respuestas en video serán utilizadas exclusivamente para el proceso de selección de CoRheSelect. 
                    Los datos serán almacenados de forma segura y solo serán accesibles por el equipo de reclutamiento autorizado.
                </p>
                <label style="display: flex; align-items: center; cursor: pointer; color: #003a8c; font-weight: 500;">
                    <input type="checkbox" id="privacyConsent" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                    He leído y acepto el uso de mis datos personales para el proceso de selección
                </label>
            </div>

            <button id="startButton" class="start-button" onclick="startEvaluation()" disabled style="opacity: 0.5; cursor: not-allowed;">
                🚀 Comenzar Evaluación
            </button>
        </div>

        <!-- SECTION TRANSITION -->
        <div id="sectionTransition" class="hidden">
            <div class="transition-icon">🌍</div>
            <h2 class="transition-title">English Assessment</h2>
            <p class="transition-message">
                Great job on the first section! Now we'll continue with the English assessment. 
                You'll answer questions in English to evaluate your language proficiency.
            </p>
            
            <div class="transition-tips">
                <h4>💡 Tips for the English Section:</h4>
                <ul>
                    <li><strong>Speak naturally:</strong> Don't worry about perfection, focus on clear communication</li>
                    <li><strong>Take your time:</strong> Use the preparation time to organize your thoughts</li>
                    <li><strong>Be yourself:</strong> We want to see your authentic communication style</li>
                </ul>
            </div>

            <button class="start-button btn-continue" onclick="continueToNextSection()">
                Continue to English Section →
            </button>
        </div>

        <!-- QUESTION CONTAINER -->
        <div id="questionContainer" class="hidden">
            <!-- Loading Overlay - NUEVO -->
            <div id="loadingOverlay" class="loading-overlay">
                <div class="loading-content">
                    <div class="spinner"></div>
                    <p id="loadingOverlayText">Guardando video...</p>
                </div>
            </div>
            
            <div class="progress-container">
                <div id="progressBar" class="progress-bar" style="width: 0%"></div>
            </div>
            
            <div class="question-header">
                <span id="questionNumber" class="question-number"></span>
                <span id="languageBadge" class="language-badge"></span>
            </div>
            
            <div id="questionText" class="question-text"></div>
            
            <!-- PREPARATION PHASE -->
            <div id="prepPhase">
                <div class="prep-phase">
                    <h3 id="prepTitle">⏱️ Tiempo de Preparación</h3>
                    <p id="prepMessage">Lee la pregunta cuidadosamente y prepara tu respuesta. Cuando estés listo/a, presiona el botón para comenzar a grabar.</p>
                    
                    <div class="prep-tips">
                        <strong>💡 Consejos:</strong>
                        <ul>
                            <li>Piensa en ejemplos concretos de tu experiencia</li>
                            <li>Estructura tu respuesta: situación → acción → resultado</li>
                            <li>Sé auténtico/a y específico/a</li>
                        </ul>
                    </div>
                    
                    <div class="timer-display" id="prepTimer">01:00</div>
                    
                    <div class="controls">
                        <button class="control-button btn-ready" onclick="startRecording()" id="readyButton">
                            🎥 <span id="readyButtonText">Estoy Listo/a - Comenzar Grabación</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- RECORDING PHASE -->
            <div id="recordingPhase" class="hidden">
                <div class="video-container">
                    <video id="videoPreview" autoplay muted playsinline></video>
                    <div id="recordingStatus" class="recording-status">
                        <div class="recording-dot"></div>
                        <span id="recordingTimer">00:00</span>
                    </div>
                </div>
                
                <div class="controls">
                    <button class="control-button btn-stop" onclick="stopRecording()" id="stopButton">
                        ⏹️ <span id="stopButtonText">Detener Grabación</span>
                    </button>
                </div>
            </div>

            <!-- REVIEW PHASE -->
            <div id="reviewPhase" class="hidden">
                <div class="video-container">
                    <video id="videoPlayback" controls playsinline></video>
                </div>
                
                <div class="controls">
                    <button class="control-button btn-retry" onclick="retryRecording()">
                        🔄 <span id="retryButtonText">Grabar de Nuevo</span>
                    </button>
                    <button class="control-button btn-next" onclick="confirmAndNext()">
                        ✅ <span id="nextButtonText">Confirmar y Continuar</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- RESULTS SCREEN -->
        <div id="resultsScreen" class="hidden">
            <div class="success-icon">🎉</div>
            <h2 class="results-title">¡Evaluación Completada!</h2>
            <p class="results-message">
                Gracias por completar tu evaluación de competencias. Tus respuestas han sido guardadas exitosamente 
                y serán revisadas por nuestro equipo de selección.<br><br>
                Te contactaremos pronto con los próximos pasos del proceso.<br><br>
                <strong>¡Mucha suerte! 🍀</strong>
            </p>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        const CONFIG = {
            AIRTABLE_BASE_ID: 'appvaNZdmHt24cHJV',
            AIRTABLE_TOKEN: 'pat8oZQ31bhFCgtiu.1b614abc17a743d1438108fab30e7d7affc095b7d0f7269d0b03dfa77b502ac6',
            EVALUATIONS_TABLE: 'tblaMFH86OlzCp9dj',
            QUESTIONS_TABLE: 'tbl8wHh68rNh4h1Zp',
            PREP_TIME_SECONDS: 60,
            MAX_RECORDING_SECONDS: 180,
            GOOGLE_SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbyI5ZK17xa-YHJzPJ9mC0EGnIXLSlAgzqtXEml_MTP-8JxfG0Iw7d1cJE0TtsyDSb9k2Q/exec'
        };

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        
        const state = {
            evaluationId: null,
            evaluation: null,
            questions: [],
            currentQuestionIndex: 0,
            currentSection: 'softskills',
            stream: null,
            mediaRecorder: null,
            recordedChunks: [],
            currentBlob: null,
            prepTimer: null,
            recordingInterval: null
        };

        // ============================================
        // AIRTABLE API
        // ============================================
        
        async function fetchFromAirtable(tableId, recordId = null) {
            const url = recordId 
                ? `https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${tableId}/${recordId}`
                : `https://api.airtable.com/v0/${CONFIG.AIRTABLE_BASE_ID}/${tableId}`;
            
            const response = await fetch(url, {
                headers: {
                    'Authorization': `Bearer ${CONFIG.AIRTABLE_TOKEN}`
                }
            });
            
            if (!response.ok) {
                throw new Error(`Airtable API error: ${response.status}`);
            }
            
            return await response.json();
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        async function init() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                state.evaluationId = urlParams.get('id');
                
                if (!state.evaluationId) {
                    showError('No se proporcionó un ID de evaluación válido.');
                    return;
                }
                
                state.evaluation = await fetchFromAirtable(CONFIG.EVALUATIONS_TABLE, state.evaluationId);
                
                if (!state.evaluation.fields['Questions IDs'] || state.evaluation.fields['Questions IDs'].length === 0) {
                    showError('Esta evaluación no tiene preguntas asignadas.');
                    return;
                }
                
                const questionIds = state.evaluation.fields['Questions IDs'];
                const questionsData = await fetchFromAirtable(CONFIG.QUESTIONS_TABLE);
                
                state.questions = questionsData.records
                    .filter(q => questionIds.includes(q.id))
                    .sort((a, b) => questionIds.indexOf(a.id) - questionIds.indexOf(b.id));
                
                if (state.questions.length === 0) {
                    showError('No se pudieron cargar las preguntas.');
                    return;
                }
                
                document.getElementById('totalQuestions').textContent = state.questions.length;
                const estimatedMinutes = Math.ceil(state.questions.length * 4);
                document.getElementById('estimatedTime').textContent = `${estimatedMinutes} minutos`;
                
                document.getElementById('loadingScreen').classList.add('hidden');
                document.getElementById('welcomeScreen').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error initializing:', error);
                showError('Error al cargar la evaluación. Por favor, verifica el enlace.');
            }
        }

        function showError(message) {
            document.getElementById('loadingScreen').innerHTML = `
                <div style="color: #dc2626; padding: 40px;">
                    <div style="font-size: 48px; margin-bottom: 20px;">⚠️</div>
                    <h2 style="margin-bottom: 10px;">Error</h2>
                    <p>${message}</p>
                </div>
            `;
        }

        // ============================================
        // EVALUATION FLOW
        // ============================================
        
        async function startEvaluation() {
            try {
                state.stream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                });
                
                document.getElementById('welcomeScreen').classList.add('hidden');
                document.getElementById('questionContainer').classList.remove('hidden');
                
                showQuestion();
                
            } catch (error) {
                alert('No se pudo acceder a la cámara y micrófono. Por favor, verifica los permisos.');
                console.error('Media access error:', error);
            }
        }

        function showQuestion() {
            const question = state.questions[state.currentQuestionIndex];
            const isEnglish = question.fields['Type'] === 'english';
            
            if (state.currentSection === 'softskills' && isEnglish) {
                state.currentSection = 'english';
                showSectionTransition();
                return;
            }
            
            const progress = ((state.currentQuestionIndex + 1) / state.questions.length) * 100;
            document.getElementById('progressBar').style.width = `${progress}%`;
            
            document.getElementById('questionNumber').textContent = 
                `Pregunta ${state.currentQuestionIndex + 1} de ${state.questions.length}`;
            
            const badge = document.getElementById('languageBadge');
            if (isEnglish) {
                badge.textContent = 'English';
                badge.className = 'language-badge english';
            } else {
                badge.textContent = 'Español';
                badge.className = 'language-badge';
            }
            
            document.getElementById('questionText').textContent = question.fields['Question text'];
            
            updateLanguageTexts(isEnglish);
            
            showPrepPhase();
        }

        function showSectionTransition() {
            document.getElementById('questionContainer').classList.add('hidden');
            document.getElementById('sectionTransition').classList.remove('hidden');
        }

        function continueToNextSection() {
            document.getElementById('sectionTransition').classList.add('hidden');
            document.getElementById('questionContainer').classList.remove('hidden');
            showQuestion();
        }

        function updateLanguageTexts(isEnglish) {
            if (isEnglish) {
                document.getElementById('prepTitle').textContent = '⏱️ Preparation Time';
                document.getElementById('prepMessage').textContent = 'Read the question carefully and prepare your answer. When ready, press the button to start recording.';
                document.getElementById('readyButtonText').textContent = "I'm Ready - Start Recording";
                document.getElementById('stopButtonText').textContent = 'Stop Recording';
                document.getElementById('retryButtonText').textContent = 'Record Again';
                document.getElementById('nextButtonText').textContent = 'Confirm and Continue';
            } else {
                document.getElementById('prepTitle').textContent = '⏱️ Tiempo de Preparación';
                document.getElementById('prepMessage').textContent = 'Lee la pregunta cuidadosamente y prepara tu respuesta. Cuando estés listo/a, presiona el botón para comenzar a grabar.';
                document.getElementById('readyButtonText').textContent = 'Estoy Listo/a - Comenzar Grabación';
                document.getElementById('stopButtonText').textContent = 'Detener Grabación';
                document.getElementById('retryButtonText').textContent = 'Grabar de Nuevo';
                document.getElementById('nextButtonText').textContent = 'Confirmar y Continuar';
            }
        }

        // ============================================
        // RECORDING PHASES
        // ============================================
        
        function showPrepPhase() {
            document.getElementById('prepPhase').classList.remove('hidden');
            document.getElementById('recordingPhase').classList.add('hidden');
            document.getElementById('reviewPhase').classList.add('hidden');
            
            startPrepTimer();
        }

        function startPrepTimer() {
            let timeLeft = CONFIG.PREP_TIME_SECONDS;
            document.getElementById('prepTimer').textContent = formatTime(timeLeft);
            
            if (state.prepTimer) {
                clearInterval(state.prepTimer);
            }
            
            state.prepTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('prepTimer').textContent = formatTime(timeLeft);
                
                if (timeLeft <= 0) {
                    clearInterval(state.prepTimer);
                }
            }, 1000);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function showRecordingPhase() {
            if (state.prepTimer) {
                clearInterval(state.prepTimer);
            }
            
            document.getElementById('prepPhase').classList.add('hidden');
            document.getElementById('recordingPhase').classList.remove('hidden');
            document.getElementById('reviewPhase').classList.add('hidden');
            
            const videoPreview = document.getElementById('videoPreview');
            videoPreview.srcObject = state.stream;
        }

        function startRecording() {
            showRecordingPhase();
            
            state.recordedChunks = [];
            
            state.mediaRecorder = new MediaRecorder(state.stream, {
                mimeType: 'video/webm;codecs=vp8,opus'
            });
            
            state.mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    state.recordedChunks.push(event.data);
                }
            };
            
            state.mediaRecorder.onstop = () => {
                state.currentBlob = new Blob(state.recordedChunks, { type: 'video/webm' });
                showReviewPhase();
            };
            
            state.mediaRecorder.start();
            document.getElementById('recordingStatus').classList.add('active');
            
            startRecordingTimer();
        }

        function stopRecording() {
            if (state.mediaRecorder && state.mediaRecorder.state === 'recording') {
                state.mediaRecorder.stop();
                
                if (state.recordingInterval) {
                    clearInterval(state.recordingInterval);
                }
                
                document.getElementById('recordingStatus').classList.remove('active');
            }
        }

        function startRecordingTimer() {
            let elapsed = 0;
            document.getElementById('recordingTimer').textContent = formatTime(elapsed);
            
            state.recordingInterval = setInterval(() => {
                elapsed++;
                document.getElementById('recordingTimer').textContent = formatTime(elapsed);
                
                if (elapsed >= CONFIG.MAX_RECORDING_SECONDS) {
                    stopRecording();
                }
            }, 1000);
        }

        function showReviewPhase() {
            document.getElementById('recordingPhase').classList.add('hidden');
            document.getElementById('reviewPhase').classList.remove('hidden');
            
            const videoPlayback = document.getElementById('videoPlayback');
            videoPlayback.src = URL.createObjectURL(state.currentBlob);
        }

        function retryRecording() {
            showRecordingPhase();
        }

        async function confirmAndNext() {
            try {
                // Mostrar overlay de loading SIN destruir el DOM
                const loadingText = state.currentSection === 'english' ? 'Saving video...' : 'Guardando video...';
                document.getElementById('loadingOverlayText').textContent = loadingText;
                document.getElementById('loadingOverlay').classList.add('active');
                
                await saveVideoResponse();
                
                // Ocultar overlay
                document.getElementById('loadingOverlay').classList.remove('active');
                
                state.currentQuestionIndex++;
                
                if (state.currentQuestionIndex < state.questions.length) {
                    showQuestion(); // Ahora funciona porque no destruimos el DOM
                } else {
                    finishEvaluation();
                }
                
            } catch (error) {
                // Ocultar overlay en caso de error
                document.getElementById('loadingOverlay').classList.remove('active');
                
                const errorText = state.currentSection === 'english' ? 
                    'Error saving video. Please try again.' : 
                    'Error al guardar el video. Por favor, intenta de nuevo.';
                alert(errorText);
                console.error('Error:', error);
            }
        }

        async function saveVideoResponse() {
            try {
                const question = state.questions[state.currentQuestionIndex];
                
                const reader = new FileReader();
                const base64Promise = new Promise((resolve) => {
                    reader.onloadend = () => resolve(reader.result);
                    reader.readAsDataURL(state.currentBlob);
                });
                
                const base64Data = await base64Promise;
                
                // Enviar a Google Sheets via Apps Script
                const response = await fetch(CONFIG.GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        evaluationId: state.evaluationId,
                        questionId: question.id,
                        videoData: base64Data,
                        videoType: question.fields['Type']
                    })
                });
                
                console.log('Video enviado a Google Sheets exitosamente');
                
            } catch (error) {
                console.error('Error guardando video:', error);
                throw error;
            }
        }


        async function finishEvaluation() {
            try {
                if (state.stream) {
                    state.stream.getTracks().forEach(track => track.stop());
                }
                
                document.getElementById('questionContainer').classList.add('hidden');
                document.getElementById('resultsScreen').classList.remove('hidden');
                
            } catch (error) {
                console.error('Error al finalizar evaluación:', error);
                document.getElementById('questionContainer').classList.add('hidden');
                document.getElementById('resultsScreen').classList.remove('hidden');
            }
        }

        // ============================================
        // INITIALIZATION ON PAGE LOAD
        // ============================================
        
        window.addEventListener('DOMContentLoaded', init);
        
        document.addEventListener('DOMContentLoaded', function() {
            const checkbox = document.getElementById('privacyConsent');
            const button = document.getElementById('startButton');
            
            if (checkbox && button) {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        button.disabled = false;
                        button.style.opacity = '1';
                        button.style.cursor = 'pointer';
                    } else {
                        button.disabled = true;
                        button.style.opacity = '0.5';
                        button.style.cursor = 'not-allowed';
                    }
                });
            }
        });
        
        window.addEventListener('beforeunload', (e) => {
            if (state.currentQuestionIndex > 0 && state.currentQuestionIndex < state.questions.length) {
                e.preventDefault();
                e.returnValue = '¿Estás seguro de que quieres salir? Tu progreso se perderá.';
            }
        });
    </script>
</body>
</html>
